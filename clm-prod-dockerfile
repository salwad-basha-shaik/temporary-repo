# Use a stable, supported JDK 17 base image (Debian-based for multi-arch compatibility)
FROM eclipse-temurin:17-jdk-jammy

LABEL author="amp-support@equinix.com" \
      description="CLM Portal Application with OpenTelemetry agent"

# Build-time args (can be overridden with --build-arg)
ARG APP_TAG
ARG VAULT_URL
ARG APP_VAULT_PROFILE_NAME
ARG OTEL_AGENT_URL="https://github.com/open-telemetry/opentelemetry-java-instrumentation/releases/latest/download/opentelemetry-javaagent.jar"

# Set working directory
WORKDIR /app

# Install required utilities and clean up apt caches in the same layer
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
      ca-certificates \
      curl \
      wget \
      openssl && \
    rm -rf /var/lib/apt/lists/*

# Application environment (set at build or runtime)
ENV spring.cloud.config.name=${APP_TAG} \
    spring.config.import=${VAULT_URL} \
    spring.profiles.active=${APP_VAULT_PROFILE_NAME}

# Download OpenTelemetry Java agent (use the build-arg or default URL)
RUN set -eux; \
    if [ -n "${OTEL_AGENT_URL}" ]; then \
      curl -fsSL -o /app/opentelemetry-javaagent.jar "${OTEL_AGENT_URL}"; \
      chmod 644 /app/opentelemetry-javaagent.jar; \
    fi

# OpenTelemetry attributes and exporter endpoint (QA value shown)
ENV OTEL_RESOURCE_ATTRIBUTES="service.name=clm-portal,env=${APP_TAG}" \
    OTEL_EXPORTER_OTLP_ENDPOINT="http://sv2lxgraapqa005:30318"

# Copy application artifact
COPY target/ClmPortal-0.0.1-SNAPSHOT.jar /app/app.jar

# Expose app port (optional, useful for documentation)
EXPOSE 8080

# Run the application with OpenTelemetry agent
ENTRYPOINT ["java", "-javaagent:/app/opentelemetry-javaagent.jar", "-jar", "/app/app.jar"]
