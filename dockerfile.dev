# Use a stable, supported base image
FROM eclipse-temurin:17-jdk-jammy

LABEL author="amp-support@equinix.com" \
      description="CLM Portal Application with OpenTelemetry agent"

# Set working directory
WORKDIR /app

# Install required utilities
RUN apt-get update && \
    apt-get install -y curl wget openssl && \
    rm -rf /var/lib/apt/lists/*

# Application configuration ARGs
ARG APP_TAG
ARG VAULT_URL
ARG APP_VAULT_PROFILE_NAME

# Environment variables
ENV spring.cloud.config.name=${APP_TAG} \
    spring.config.import=${VAULT_URL} \
    spring.profiles.active=${APP_VAULT_PROFILE_NAME}

# Download OpenTelemetry Java agent
ARG OTEL_AGENT_URL="https://github.com/open-telemetry/opentelemetry-java-instrumentation/releases/latest/download/opentelemetry-javaagent.jar"
RUN wget -O /app/opentelemetry-javaagent.jar ${OTEL_AGENT_URL}

# Set OpenTelemetry attributes
ENV OTEL_RESOURCE_ATTRIBUTES="serviceName=clm-portal,env=${APP_TAG}" \
    OTEL_EXPORTER_OTLP_ENDPOINT="http://sv2lxgraapqa005:30318"

# Copy application JAR
COPY target/ClmPortal-0.0.1-SNAPSHOT.jar /app/app.jar

# Expose port (if required for your app)
EXPOSE 8080

# Run application
ENTRYPOINT ["java", "-javaagent:/app/opentelemetry-javaagent.jar", "-jar", "app.jar"]
